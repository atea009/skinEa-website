<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkinEa</title>

    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
</head>

<body>
    <div class="app-container">
        <header class="header">
            <div class="top-bar">
                <a href="index.html">
                    <img src="icons/SkinEa.png" alt="SkinEa logo" class="skinea_logo" />
                </a>

                <img src="icons/settings_icon.png" alt="Settings" class="settings-icon" />
            </div>
        </header>

        <div class="settings-popup-overlay" id="settingsPopupOverlay"></div>

        <div class="settings-popup" id="settingsPopup">
            <div class="popup-header">
                <img src="icons/back1.png" alt="Back" class="popup-back" id="settingsCloseBtn" />
                <h2>Profile</h2>
            </div>

            <div class="popup-scroll-area">

                <!-- My Details veç -->

                <div class="popup-option standalone" id="detailsToggle">
                    <img src="icons/user.png" />
                    <span>My Details</span>
                </div>
                <div class="details-dropdown" id="detailsDropdown">
                    <!-- Përmbajtja e xhepit -->
                    <p class="detail-line">Username: Atea</p>
                    <p class="detail-line">Email: skin@example.com</p>
                    <div class="detail-group">
                        <div class="detail-row">
                            <span class="detail-label">Gender</span>
                            <select class="detail-select">
                            <option>Female</option>
                            <option>Male</option>
                            <option>Other</option>
                          </select>
                        </div>

                        <div class="detail-row">
                            <span class="detail-label">Birthyear</span>
                            <input type="date" class="detail-input" />
                        </div>
                    </div>
                    <div class="skin-section">
                        <p class="detail-label">Skin Color</p>
                        <div class="skincolor-grid">
                            <div class="skincolor color-1 "></div>
                            <div class="skincolor color-2"></div>
                            <div class="skincolor color-3 selected"></div>
                            <div class="skincolor color-4"></div>
                            <div class="skincolor color-5"></div>
                            <div class="skincolor color-6"></div>
                        </div>
                    </div>


                    <div class="skin-section">
                        <p class="detail-label">Skin Type</p>
                        <div class="skin-types">
                            <button class="skin-btn selected">Normal</button>
                            <button class="skin-btn ">Combined</button>
                            <button class="skin-btn">Oily</button>
                            <button class="skin-btn">Dry</button>
                        </div>
                    </div>

                    <div class="skin-section">
                        <p class="detail-label">Skin Issue</p>
                        <div class="issue-tags">
                            <button class="issue-btn">Acne</button>
                            <button class="issue-btn">Redness</button>
                            <button class="issue-btn">Wrinkles/ Fine lines</button>
                            <button class="issue-btn">Large pores</button>
                            <button class="issue-btn">Sensitivity</button>
                        </div>
                    </div>


                </div>

                <!-- Grupi tjeter -->
                <div class="options-group">

                    <a class="popup-option" href="howtouse.html">
                        <img src="icons/info.png" />
                        <span>How to Use</span>
                    </a>
                    <a class="popup-option" href="guide.html">
                        <img src="icons/question.png" />
                        <span>SkinEa Guide</span>
                    </a>
                    <a class="popup-option" href="privacy.html">
                        <img src="icons/policy.png" />
                        <span>Privacy Policy</span>
                    </a>
                    <a class="popup-option" href="terms.html">
                        <img src="icons/terms.png" />
                        <span>Terms of Use</span>
                    </a>

                    <div class="popup-option" id="shareAppBtn">
                        <img src="icons/share.png" />
                        <span>Share App</span>
                    </div>

                    <a href="mailto:skineaapp@gmail.com" class="popup-option">
                        <img src="icons/email.png" />
                        <span>Contact Us</span>
                    </a>

                    <div class="popup-option">
                        <img src="icons/star.png" />
                        <span>Rate Us</span>
                    </div>
                </div>
                <div class="logout-container">
                    <button class="logout-btn" onclick="window.location.href='index.html'">Log Out</button>
                </div>

            </div>
        </div>


        <main>

            <section class="scan-section">

                <div class="info-icon-container">
                    <a href="info.html">
                        <img src="icons/info.png" alt="Info Icon" />
                    </a>
                </div>


                <div class="scan-container">
                    <div class="drop-area">
                        <img src="https://cdn-icons-png.flaticon.com/512/109/109612.png" alt="Upload Icon">
                        <p>Click or Drag & Drop to Upload Your Photo</p>
                        <input type="file" id="imageUpload" accept="image/*" hidden>
                    </div>
                    <div class="image-container"></div>
                    <div class="label-container"></div>
                    <div class="time-container"></div>
                </div>
            </section>

            <!-- Seksioni Skin Cancer Awareness fillimisht i fshehur -->

            <section class="skin-cancer-section" style="display: none; ">
                <section class="horizontal-scroll-section">
                    <div class="section-header">
                        <h2 class="section-title">Skin cancer awareness</h2>
                    </div>

                    <div class="horizontal-grid">
                        <div class="blog-card" data-type="skin cancer" data-stories="icons/story1.jpg,icons/story2.jpg,icons/story7.mp4">
                            <img src="icons/blog_image.png" alt="Blog Image" class="blog-image" />
                            <div class="blog-bottom">
                                <p class="blog-title">Don't forget to use SPF</p>
                            </div>
                        </div>

                        <div class="blog-card" data-type="skin cancer" data-stories="icons/story1.jpg,icons/story2.jpg,icons/story3.jpg">
                            <img src="icons/blog_image.png" alt="Blog Image" class="blog-image" />
                            <div class="blog-bottom">
                                <p class="blog-title">Check your moles regularly</p>
                            </div>
                        </div>

                        <div class="blog-card" data-type="skin cancer">
                            <img src="icons/blog_image.png" alt="Blog Image" class="blog-image" />
                            <div class="blog-bottom">
                                <p class="blog-title">Don't forget to use SPF</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Popup për Stories -->
                <div id="story-popup" class="story-popup">
                    <div class="story-content">
                        <div class="story-bars" id="story-bars"></div>
                        <span class="close-btn">&times;</span>
                        <img src="" alt="Story Image" class="story-image" id="story-image" />
                        <video class="story-video" id="story-video" muted playsinline></video>
                    </div>
                </div>
            </section>

        </main>

        <footer class="footer">
            <div class="footer-nav">
                <a href="aichat.html" class="footer-btn">
                    <img src="icons/Ai_icon.png" alt="AI Chat" />
                    <span>AI Chat</span>
                </a>
                <a href="scan.html" class="footer-btn active">
                    <img src="icons/active_scan.png" alt="Mole Scan" />
                    <span>Scanner</span>
                </a>
                <a href="home.html" class="footer-btn">
                    <img src="icons/home_icon.png" alt="Home" />
                    <span>Home</span>
                </a>
                <a href="products.html" class="footer-btn">
                    <img src="icons/products_icon.png" alt="Products" />
                    <span>Products</span>
                </a>
                <a href="blog.html" class="footer-btn">
                    <img src="icons/blog_icon.png" alt="Blog" />
                    <span>Blog</span>
                </a>
            </div>

            <div class="home-indicator">
                <img src="icons/home_indicator.png" alt="home_indicator" />
            </div>
        </footer>
    </div>

    <script>
        const settingsIcon = document.querySelector('.settings-icon');
        const settingsPopup = document.getElementById('settingsPopup');
        const settingsOverlay = document.getElementById('settingsPopupOverlay');
        const settingsCloseBtn = document.getElementById('settingsCloseBtn');
        const detailsToggle = document.getElementById('detailsToggle');
        const detailsDropdown = document.getElementById('detailsDropdown');

        // Hap popup
        function openSettingsPopup() {
            settingsPopup.style.transform = 'translate(-50%, 0)';
            settingsOverlay.style.display = 'block';
        }

        // Mbyll popup + dropdown
        function closeSettingsPopup() {
            settingsPopup.style.transform = 'translate(-50%, 100%)';
            setTimeout(() => {
                settingsOverlay.style.display = 'none';
                detailsDropdown.style.display = 'none'; // mbyll dropdown automatikisht
            }, 700);
        }

        // Klikime
        settingsIcon.addEventListener('click', openSettingsPopup);
        settingsCloseBtn.addEventListener('click', closeSettingsPopup);
        settingsOverlay.addEventListener('click', closeSettingsPopup);

        // Mbyllje me swipe nga pjesa e sipërme (vetëm 5% e sipërme aktive)
        let settingsStartY = 0;
        let settingsCurrentY = 0;
        let isSwiping = false;

        settingsPopup.addEventListener('touchstart', (e) => {
            const touchY = e.touches[0].clientY;
            const popupTop = settingsPopup.getBoundingClientRect().top;
            const height = settingsPopup.offsetHeight;

            if ((touchY - popupTop) <= height * 0.05) {
                settingsStartY = touchY;
                isSwiping = true;
                settingsPopup.style.transition = 'none';
            }
        });

        settingsPopup.addEventListener('touchmove', (e) => {
            if (!isSwiping) return;
            settingsCurrentY = e.touches[0].clientY;
            const diffY = settingsCurrentY - settingsStartY;
            if (diffY > 0) {
                settingsPopup.style.transform = `translate(-50%, ${diffY}px)`;
            }
        });

        settingsPopup.addEventListener('touchend', () => {
            if (!isSwiping) return;
            isSwiping = false;

            const diffY = settingsCurrentY - settingsStartY;
            settingsPopup.style.transition = 'transform 0.7s ease-in-out';

            if (diffY > 100) {
                closeSettingsPopup();
            } else {
                settingsPopup.style.transform = 'translate(-50%, 0)';
            }
        });

        // Dropdown toggle për "My Details"
        detailsToggle.addEventListener('click', () => {
            if (detailsDropdown.style.display === 'block') {
                detailsDropdown.style.display = 'none';
            } else {
                detailsDropdown.style.display = 'block';
            }
        });
    </script>

    <script>
        document.querySelectorAll('.skincolor').forEach(circle => {
            circle.addEventListener('click', () => {
                document.querySelectorAll('.skincolor').forEach(c => c.classList.remove('selected'));
                circle.classList.add('selected');
            });
        });
    </script>

    <script>
        document.querySelectorAll('.skin-btn').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.skin-btn').forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
            });
        });
    </script>

    <script>
        document.querySelectorAll('.issue-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('selected');
            });
        });
    </script>

    <script>
        const shareBtn = document.getElementById('shareAppBtn');
        shareBtn.addEventListener('click', async() => {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'SkinEa App',
                        text: 'Check out this skincare assistant app!',
                        url: 'https://skinea.netlify.app/'
                    });
                } catch (err) {
                    console.error('Sharing failed:', err);
                }
            } else {
                alert('Sharing not supported on this device/browser.');
            }
        });
    </script>

    <script>
        const URL = "https://teachablemachine.withgoogle.com/models/Nzm7SqHut/";
        let model, labelContainer, maxPredictions;

        async function init() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();
            labelContainer = document.querySelector(".label-container");
        }

        // Përkthimi nga shqip në anglisht për rezultatet
        function translateClassName(className) {
            const clean = className.trim().toLowerCase();
            if (clean === "kancerogjene") return "Needs Medical Review";
            if (clean === "jo-kancerogjene") return "No Immediate Concern";
            return className;
        }

        async function predict(imageElement) {
            const startTime = performance.now();
            const prediction = await model.predict(imageElement);
            const endTime = performance.now();
            const elapsedTime = (endTime - startTime).toFixed(2);

            labelContainer.innerHTML = "";

            let maxIndex = 0;
            for (let i = 1; i < prediction.length; i++) {
                if (prediction[i].probability > prediction[maxIndex].probability) {
                    maxIndex = i;
                }
            }

            const bestPrediction = prediction[maxIndex];
            const percentage = (bestPrediction.probability * 100).toFixed(2);
            const translatedClassName = translateClassName(bestPrediction.className); // <- Përkthimi këtu

            const progressBar = document.createElement("div");
            progressBar.className = "progress-bar";

            const progress = document.createElement("div");
            progress.className = "progress " + (percentage > 50 ? "pink-bar" : "orange-bar");
            progress.style.width = percentage + "%";
            progress.innerText = `${translatedClassName}: ${percentage}%`;

            progressBar.appendChild(progress);
            labelContainer.appendChild(progressBar);

            document.querySelector(".time-container").innerText = `Analysis Time: ${elapsedTime} ms`;

            // Shfaq seksionin Skin Cancer Awareness
            document.querySelector(".skin-cancer-section").style.display = "block";
        }

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    document.querySelector(".image-container").innerHTML = "";
                    document.querySelector(".image-container").appendChild(img);
                    predict(img);
                };
            };
            reader.readAsDataURL(file);
        }

        document.getElementById("imageUpload").addEventListener("change", function(event) {
            if (event.target.files.length > 0) {
                handleFile(event.target.files[0]);
            }
        });

        const dropArea = document.querySelector(".drop-area");
        dropArea.addEventListener("click", () => document.getElementById("imageUpload").click());
        dropArea.addEventListener("dragover", (event) => {
            event.preventDefault();
            dropArea.style.borderColor = "#ff6b81";
        });
        dropArea.addEventListener("dragleave", () => dropArea.style.borderColor = "#ccc");
        dropArea.addEventListener("drop", (event) => {
            event.preventDefault();
            dropArea.style.borderColor = "#ccc";
            if (event.dataTransfer.files.length > 0) {
                handleFile(event.dataTransfer.files[0]);
            }
        });

        init();
    </script>



    <script>
        const blogCards = document.querySelectorAll('.blog-card');

        blogCards.forEach(card => {
            const type = card.getAttribute('data-type');
            const blogBottom = card.querySelector('.blog-bottom');

            if (type && blogBottom) {
                // Krijojmë badge-in
                const badge = document.createElement('div');
                badge.classList.add('blog-type');

                // Krijojmë ikonën
                const icon = document.createElement('img');
                icon.classList.add('badge-icon');

                // Krijojmë tekstin
                const text = document.createElement('span');
                text.classList.add('badge-text');

                switch (type.trim().toLowerCase()) {
                    case "skin cancer":
                        badge.style.background = '#F3A5DA'; // rozë
                        icon.src = "icons/cancer_ribbon.png"; // ikona për skin cancer
                        text.textContent = "Awareness";
                        break;

                    case "skin care":
                        badge.style.background = '#D1B1E0'; // lejla
                        icon.src = "icons/skin_icon.png"; // ikona për skin care
                        text.textContent = "Skin Care";
                        break;

                    case "e-books":
                        badge.style.background = '#B3DFE1'; // kaltër
                        icon.src = "icons/book_icon.png"; // ikona për e-books
                        text.textContent = "E-Books";
                        break;

                    default:
                        badge.style.background = '#cccccc';
                        text.textContent = "Unknown";
                }

                // Bashkojmë ikonën dhe tekstin në badge
                badge.appendChild(icon);
                badge.appendChild(text);

                // Futim badge-in përpara titullit
                blogBottom.insertBefore(badge, blogBottom.querySelector('.blog-title'));
            }
        });
    </script>


    <!-- SCRIPT për Story Popup -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const blogCards = document.querySelectorAll('.blog-card');
            const popup = document.getElementById('story-popup');
            const storyImage = document.getElementById('story-image');
            const storyVideo = document.getElementById('story-video');
            const storyBars = document.getElementById('story-bars');
            const closeBtn = document.querySelector('.close-btn');

            let images = [];
            let currentImage = 0;
            let timer;
            let isPaused = false;
            let startY = 0;
            const animationDuration = 5000; // 5 sekonda

            function openPopup(imgArray) {
                images = imgArray;
                currentImage = 0;
                popup.style.display = 'flex';
                renderBars();
                showImage(currentImage);
            }

            function closePopup() {
                clearTimeout(timer);
                const storyContent = popup.querySelector('.story-content');
                popup.style.background = 'transparent';
                storyContent.classList.add('closing-animation');
                storyContent.addEventListener('animationend', () => {
                    popup.style.display = 'none';
                    popup.style.background = 'rgba(0, 0, 0, 0.8)';
                    storyContent.classList.remove('closing-animation');
                    currentImage = 0;
                }, {
                    once: true
                });
            }

            function renderBars() {
                storyBars.innerHTML = '';
                images.forEach(() => {
                    const bar = document.createElement('div');
                    bar.className = 'story-bar';
                    const fill = document.createElement('div');
                    fill.className = 'story-bar-fill';
                    bar.appendChild(fill);
                    storyBars.appendChild(bar);
                });
            }

            function showImage(index) {
                const fills = document.querySelectorAll('.story-bar-fill');
                const currentSrc = images[index];

                fills.forEach((fill, i) => {
                    fill.style.width = i < index ? '100%' : '0';
                    fill.style.animation = 'none';
                });

                if (fills[index]) {
                    void fills[index].offsetWidth;
                }

                if (currentSrc.endsWith('.mp4') || currentSrc.endsWith('.mov') || currentSrc.endsWith('.webm')) {
                    storyImage.style.display = 'none';
                    storyVideo.style.display = 'block';
                    storyVideo.src = currentSrc;
                    storyVideo.load();
                    storyVideo.onloadedmetadata = () => {
                        const videoDuration = storyVideo.duration * 1000;
                        fills[index].style.animation = `progressAnimation ${videoDuration / 1000}s linear forwards`;
                        fills[index].style.animationPlayState = 'running';
                        storyVideo.play();
                        startTimer(videoDuration);
                    };
                } else {
                    storyVideo.pause();
                    storyVideo.style.display = 'none';
                    storyImage.style.display = 'block';
                    storyImage.onload = () => {
                        fills[index].style.animation = `progressAnimation ${animationDuration / 1000}s linear forwards`;
                        fills[index].style.animationPlayState = 'running';
                        startTimer(animationDuration);
                    };
                    storyImage.src = currentSrc;
                }
            }

            function startTimer(duration) {
                clearTimeout(timer);
                timer = setTimeout(() => {
                    currentImage++;
                    if (currentImage < images.length) {
                        showImage(currentImage);
                    } else {
                        closePopup();
                    }
                }, duration);
            }

            blogCards.forEach(card => {
                card.addEventListener('click', function() {
                    const storiesData = card.getAttribute('data-stories');
                    if (storiesData) {
                        const storiesArray = storiesData.split(',').map(s => s.trim());
                        openPopup(storiesArray);
                    }
                });
            });

            closeBtn.addEventListener('click', closePopup);

            popup.addEventListener('click', (e) => {
                if (isPaused) return;

                const x = e.clientX;
                const width = window.innerWidth;

                clearTimeout(timer);

                if (x < width / 2) {
                    // Klik majtas - back
                    if (currentImage > 0) {
                        currentImage--;
                        showImage(currentImage);
                    } else {
                        showImage(currentImage);
                    }
                } else {
                    // Klik djathtas - next
                    currentImage++;
                    if (currentImage < images.length) {
                        showImage(currentImage);
                    } else {
                        closePopup();
                    }
                }
            });

            popup.addEventListener('mousedown', () => {
                if (!isPaused) {
                    isPaused = true;
                    clearTimeout(timer);
                    const fills = document.querySelectorAll('.story-bar-fill');
                    if (fills[currentImage]) {
                        fills[currentImage].style.animationPlayState = 'paused';
                    }
                }
            });

            popup.addEventListener('mouseup', () => {
                if (isPaused) {
                    isPaused = false;
                    const fills = document.querySelectorAll('.story-bar-fill');
                    if (fills[currentImage]) {
                        fills[currentImage].style.animationPlayState = 'running';
                    }
                    startTimer(animationDuration);
                }
            });

            popup.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
                if (!isPaused) {
                    isPaused = true;
                    clearTimeout(timer);
                    const fills = document.querySelectorAll('.story-bar-fill');
                    if (fills[currentImage]) {
                        fills[currentImage].style.animationPlayState = 'paused';
                    }
                }
            });

            popup.addEventListener('touchend', (e) => {
                const endY = e.changedTouches[0].clientY;
                if (endY - startY > 100) {
                    closePopup();
                } else {
                    if (isPaused) {
                        isPaused = false;
                        const fills = document.querySelectorAll('.story-bar-fill');
                        if (fills[currentImage]) {
                            fills[currentImage].style.animationPlayState = 'running';
                        }
                        startTimer(animationDuration);
                    }
                }
            });
        });
    </script>

</body>

</html>